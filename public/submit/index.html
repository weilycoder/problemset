<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submit Problem</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/styles.css" />
</head>

<body>
    <main class="page">
        <section class="hero">
            <h1 class="title">Submit Problem</h1>
            <p class="subtitle">Share a new challenge with the problem set.</p>
        </section>

        <section class="panel">
            <form class="form-grid" id="submit-form">
                <div class="field">
                    <label for="problem-title">Title</label>
                    <input id="problem-title" name="title" type="text" placeholder="e.g. 1 + 1 Problem" required />
                </div>

                <div class="field">
                    <label for="admin-key">Admin Key</label>
                    <input id="admin-key" name="adminKey" type="password" placeholder="Enter admin passphrase"
                        required />
                </div>

                <div class="field span-2">
                    <label for="problem-content">Content</label>
                    <textarea id="problem-content" name="content" rows="10" placeholder="Full problem description."
                        required></textarea>
                </div>

                <div class="actions span-2">
                    <button type="submit" class="primary">Submit Problem</button>
                    <a class="text-link" href="/">Back to list</a>
                </div>
            </form>

            <div class="status" id="submit-status">Fill out the form to submit a new problem.</div>
        </section>
    </main>
    <script>
        const form = document.getElementById("submit-form");
        const statusEl = document.getElementById("submit-status");
        const titleInput = document.getElementById("problem-title");
        const contentInput = document.getElementById("problem-content");
        const actionsRow = document.querySelector(".actions");

        function isTitleValid(title) {
            return !/[^a-zA-Z0-9\s-]/.test(title);
        }

        async function preloadProblem() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get("id");
            if (!id) {
                return;
            }

            addDeleteButton(id);

            statusEl.textContent = "Loading problem...";
            try {
                const response = await fetch(`/api/problem/${encodeURIComponent(id)}`);
                if (!response.ok) {
                    window.location.href = "/submit";
                    return;
                }

                titleInput.value = id;
                titleInput.disabled = true;
                contentInput.value = await response.text();
                form.dataset.problemId = id;
                statusEl.textContent = "Loaded. Update content and submit to save.";
            } catch (error) {
                statusEl.textContent = "Network error. Please try again.";
                console.error(error);
            }
        }

        function addDeleteButton(id) {
            if (!actionsRow || actionsRow.querySelector(".danger")) {
                return;
            }

            const deleteButton = document.createElement("button");
            deleteButton.type = "button";
            deleteButton.className = "danger";
            deleteButton.textContent = "Delete Problem";
            deleteButton.addEventListener("click", async () => {
                const adminKey = document.getElementById("admin-key").value.trim();
                if (!adminKey) {
                    statusEl.textContent = "Please enter the admin key to delete.";
                    return;
                }

                if (!window.confirm("Delete this problem? This cannot be undone.")) {
                    return;
                }

                statusEl.textContent = "Deleting...";
                try {
                    const response = await fetch(`/api/problem/${encodeURIComponent(id)}`,
                        {
                            method: "DELETE",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ verification: adminKey })
                        }
                    );

                    if (response.ok) {
                        window.location.href = "/";
                        return;
                    }

                    const message = await response.text();
                    statusEl.textContent = message || "Delete failed.";
                } catch (error) {
                    statusEl.textContent = "Network error. Please try again.";
                    console.error(error);
                }
            });

            actionsRow.appendChild(deleteButton);
        }

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            statusEl.textContent = "Submitting...";

            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            const adminKey = document.getElementById("admin-key").value.trim();
            const existingId = form.dataset.problemId;

            if (!title || !content || !adminKey) {
                statusEl.textContent = "Please fill in all fields.";
                return;
            }

            if (!existingId && !isTitleValid(title)) {
                statusEl.textContent = "Title contains invalid characters. Use letters, numbers, spaces, or dashes.";
                return;
            }

            const payload = {
                verification: adminKey,
                problem: content,
            };

            const targetId = existingId || title;

            try {
                const response = await fetch(`/api/problem/${encodeURIComponent(targetId)}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    }
                );

                if (response.ok) {
                    statusEl.textContent = "Submitted successfully.";
                    if (!existingId) {
                        form.reset();
                    }
                } else {
                    const message = await response.text();
                    statusEl.textContent = message || "Submit failed.";
                }
            } catch (error) {
                statusEl.textContent = "Network error. Please try again.";
                console.error(error);
            }
        });

        preloadProblem();
    </script>
</body>

</html>